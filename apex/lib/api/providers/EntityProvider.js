"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.EntityProvider = void 0;
const app = require("..");
class EntityProvider {
    constructor() {
        this.createEntities = new Map();
        this.deleteEntities = new Map();
        this.livingEntities = new Map();
        this.lookupEntities = new Map();
        this.releasedIds = [];
        this.nextId = 0;
    }
    create(entity) {
        const id = this.releasedIds.pop();
        if (typeof id !== 'undefined') {
            this.createEntities.set(id, entity);
            this.lookupEntities.set(entity, id);
        }
        else {
            const id = this.nextId;
            this.createEntities.set(id, entity);
            this.lookupEntities.set(entity, id);
            this.nextId++;
        }
    }
    delete(entity) {
        const id = this.lookupEntities.get(entity);
        if (typeof id === 'undefined') {
            throw new Error();
        }
        else if (this.createEntities.has(id)) {
            this.createEntities.delete(id);
            this.lookupEntities.delete(entity);
        }
        else if (this.livingEntities.has(id)) {
            this.deleteEntities.set(id, entity);
            this.livingEntities.delete(id);
            this.lookupEntities.delete(entity);
        }
    }
    receive(packet) {
        if (packet instanceof app.EntityUpdate) {
            this.receiveUpdate(packet);
        }
        else {
            this.receiveSync(packet);
        }
    }
    update(stream, syncId) {
        for (const id of this.deleteEntities.keys()) {
            const packet = new app.EntityDelete(id);
            this.deleteEntities.delete(id);
            this.releasedIds.push(id);
            packet.write(stream);
        }
        for (const [id, entity] of this.createEntities) {
            const packet = new app.EntityCreate(id, entity.address, convertMembers(entity.members), Boolean(entity.options?.requestBatch));
            this.createEntities.delete(id);
            this.livingEntities.set(id, entity);
            packet.write(stream);
        }
        for (const [id, entity] of this.livingEntities) {
            if (!entity.options || !entity.options.enableUpdate)
                continue;
            const packet = entity.update(id, syncId);
            if (!packet)
                continue;
            packet.write(stream);
        }
    }
    receiveUpdate(packet) {
        for (const child of packet.entities) {
            const entity = this.livingEntities.get(child.id);
            if (!entity)
                continue;
            entity.receive(child);
        }
    }
    receiveSync(packet) {
        for (const entity of this.livingEntities.values()) {
            if (!entity.options || !entity.options.enableUpdate)
                continue;
            entity.receive(packet);
        }
    }
}
exports.EntityProvider = EntityProvider;
function convertMembers(members) {
    const result = [];
    for (const [id, member] of members)
        result.push(new app.EntityCreateMember(id, member.interval, member.buffer.byteLength));
    return result;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRW50aXR5UHJvdmlkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvbGliL2FwaS9wcm92aWRlcnMvRW50aXR5UHJvdmlkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsMEJBQTBCO0FBRTFCLE1BQWEsY0FBYztJQUEzQjtRQUNtQixtQkFBYyxHQUFHLElBQUksR0FBRyxFQUFzQixDQUFDO1FBQy9DLG1CQUFjLEdBQUcsSUFBSSxHQUFHLEVBQXNCLENBQUM7UUFDL0MsbUJBQWMsR0FBRyxJQUFJLEdBQUcsRUFBc0IsQ0FBQztRQUMvQyxtQkFBYyxHQUFHLElBQUksR0FBRyxFQUFzQixDQUFDO1FBQy9DLGdCQUFXLEdBQWtCLEVBQUUsQ0FBQztRQUN6QyxXQUFNLEdBQUcsQ0FBQyxDQUFDO0lBd0VyQixDQUFDO0lBdEVDLE1BQU0sQ0FBQyxNQUFrQjtRQUN2QixNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQ2xDLElBQUksT0FBTyxFQUFFLEtBQUssV0FBVyxFQUFFO1lBQzdCLElBQUksQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxNQUFNLENBQUMsQ0FBQztZQUNwQyxJQUFJLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLENBQUM7U0FDckM7YUFBTTtZQUNMLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7WUFDdkIsSUFBSSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBQ3BDLElBQUksQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQztZQUNwQyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7U0FDZjtJQUNILENBQUM7SUFFRCxNQUFNLENBQUMsTUFBa0I7UUFDdkIsTUFBTSxFQUFFLEdBQUcsSUFB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QUFDLENBQUM7WUFDakQsSUFBSSxDQUFDLE1BQU07Z0JBQUUsU0FBUztZQUN0QixNQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ3ZCO0lBQ0gsQ0FBQztJQUVPLFdBQVcsQ0FBQyxNQUFxQjtRQUN2QyxLQUFLLE1BQU0sTUFBTSxJQUFJLElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxFQUFFLEVBQUU7WUFDakQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLFlBQVk7Z0JBQUUsU0FBUztZQUM5RCxNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQ3hCO0lBQ0gsQ0FBQztDQUNGO0FBOUVELHdDQThFQztBQUVELFNBQVMsY0FBYyxDQUFDLE9BQXNDO0lBQzVELE1BQU0sTUFBTSxHQUFrQyxFQUFFLENBQUM7SUFDakQsS0FBSyxNQUFNLENBQUMsRUFBRSxFQUFFLE1BQU0sQ0FBQyxJQUFJLE9BQU87UUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksR0FBRyxDQUFDLGtCQUFrQixDQUFDLEVBQUUsRUFBRSxNQUFNLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztJQUMzSCxPQUFPLE1BQU0sQ0FBQztBQUNoQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgYXBwIGZyb20gJy4uJztcclxuXHJcbmV4cG9ydCBjbGFzcyBFbnRpdHlQcm92aWRlciBpbXBsZW1lbnRzIGFwcC5JUGFja2V0UHJvdmlkZXIge1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgY3JlYXRlRW50aXRpZXMgPSBuZXcgTWFwPG51bWJlciwgYXBwLkVudGl0eT4oKTtcclxuICBwcml2YXRlIHJlYWRvbmx5IGRlbGV0ZUVudGl0aWVzID0gbmV3IE1hcDxudW1iZXIsIGFwcC5FbnRpdHk+KCk7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBsaXZpbmdFbnRpdGllcyA9IG5ldyBNYXA8bnVtYmVyLCBhcHAuRW50aXR5PigpO1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgbG9va3VwRW50aXRpZXMgPSBuZXcgTWFwPGFwcC5FbnRpdHksIG51bWJlcj4oKTtcclxuICBwcml2YXRlIHJlYWRvbmx5IHJlbGVhc2VkSWRzOiBBcnJheTxudW1iZXI+ID0gW107XHJcbiAgcHJpdmF0ZSBuZXh0SWQgPSAwO1xyXG5cclxuICBjcmVhdGUoZW50aXR5OiBhcHAuRW50aXR5KSB7XHJcbiAgICBjb25zdCBpZCA9IHRoaXMucmVsZWFzZWRJZHMucG9wKCk7XHJcbiAgICBpZiAodHlwZW9mIGlkICE9PSAndW5kZWZpbmVkJykge1xyXG4gICAgICB0aGlzLmNyZWF0ZUVudGl0aWVzLnNldChpZCwgZW50aXR5KTtcclxuICAgICAgdGhpcy5sb29rdXBFbnRpdGllcy5zZXQoZW50aXR5LCBpZCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBjb25zdCBpZCA9IHRoaXMubmV4dElkO1xyXG4gICAgICB0aGlzLmNyZWF0ZUVudGl0aWVzLnNldChpZCwgZW50aXR5KTtcclxuICAgICAgdGhpcy5sb29rdXBFbnRpdGllcy5zZXQoZW50aXR5LCBpZCk7XHJcbiAgICAgIHRoaXMubmV4dElkKys7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBkZWxldGUoZW50aXR5OiBhcHAuRW50aXR5KSB7XHJcbiAgICBjb25zdCBpZCA9IHRoaXMubG9va3VwRW50aXRpZXMuZ2V0KGVudGl0eSk7XHJcbiAgICBpZiAodHlwZW9mIGlkID09PSAndW5kZWZpbmVkJykge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoKTtcclxuICAgIH0gZWxzZSBpZiAodGhpcy5jcmVhdGVFbnRpdGllcy5oYXMoaWQpKSB7XHJcbiAgICAgIHRoaXMuY3JlYXRlRW50aXRpZXMuZGVsZXRlKGlkKTtcclxuICAgICAgdGhpcy5sb29rdXBFbnRpdGllcy5kZWxldGUoZW50aXR5KTtcclxuICAgIH0gZWxzZSBpZiAodGhpcy5saXZpbmdFbnRpdGllcy5oYXMoaWQpKSB7XHJcbiAgICAgIHRoaXMuZGVsZXRlRW50aXRpZXMuc2V0KGlkLCBlbnRpdHkpO1xyXG4gICAgICB0aGlzLmxpdmluZ0VudGl0aWVzLmRlbGV0ZShpZCk7XHJcbiAgICAgIHRoaXMubG9va3VwRW50aXRpZXMuZGVsZXRlKGVudGl0eSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICByZWNlaXZlKHBhY2tldDogYXBwLkJhc2ljU3luYyB8IGFwcC5FbnRpdHlVcGRhdGUpIHtcclxuICAgIGlmIChwYWNrZXQgaW5zdGFuY2VvZiBhcHAuRW50aXR5VXBkYXRlKSB7XHJcbiAgICAgIHRoaXMucmVjZWl2ZVVwZGF0ZShwYWNrZXQpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5yZWNlaXZlU3luYyhwYWNrZXQpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgdXBkYXRlKHN0cmVhbTogYXBwLkJpbmFyeVdyaXRlciwgc3luY0lkOiBudW1iZXIpIHtcclxuICAgIGZvciAoY29uc3QgaWQgb2YgdGhpcy5kZWxldGVFbnRpdGllcy5rZXlzKCkpIHtcclxuICAgICAgY29uc3QgcGFja2V0ID0gbmV3IGFwcC5FbnRpdHlEZWxldGUoaWQpO1xyXG4gICAgICB0aGlzLmRlbGV0ZUVudGl0aWVzLmRlbGV0ZShpZCk7XHJcbiAgICAgIHRoaXMucmVsZWFzZWRJZHMucHVzaChpZCk7XHJcbiAgICAgIHBhY2tldC53cml0ZShzdHJlYW0pO1xyXG4gICAgfVxyXG4gICAgZm9yIChjb25zdCBbaWQsIGVudGl0eV0gb2YgdGhpcy5jcmVhdGVFbnRpdGllcykge1xyXG4gICAgICBjb25zdCBwYWNrZXQgPSBuZXcgYXBwLkVudGl0eUNyZWF0ZShpZCwgZW50aXR5LmFkZHJlc3MsIGNvbnZlcnRNZW1iZXJzKGVudGl0eS5tZW1iZXJzKSwgQm9vbGVhbihlbnRpdHkub3B0aW9ucz8ucmVxdWVzdEJhdGNoKSk7XHJcbiAgICAgIHRoaXMuY3JlYXRlRW50aXRpZXMuZGVsZXRlKGlkKTtcclxuICAgICAgdGhpcy5saXZpbmdFbnRpdGllcy5zZXQoaWQsIGVudGl0eSk7XHJcbiAgICAgIHBhY2tldC53cml0ZShzdHJlYW0pO1xyXG4gICAgfVxyXG4gICAgZm9yIChjb25zdCBbaWQsIGVudGl0eV0gb2YgdGhpcy5saXZpbmdFbnRpdGllcykge1xyXG4gICAgICBpZiAoIWVudGl0eS5vcHRpb25zIHx8ICFlbnRpdHkub3B0aW9ucy5lbmFibGVVcGRhdGUpIGNvbnRpbnVlO1xyXG4gICAgICBjb25zdCBwYWNrZXQgPSBlbnRpdHkudXBkYXRlKGlkLCBzeW5jSWQpO1xyXG4gICAgICBpZiAoIXBhY2tldCkgY29udGludWU7XHJcbiAgICAgIHBhY2tldC53cml0ZShzdHJlYW0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSByZWNlaXZlVXBkYXRlKHBhY2tldDogYXBwLkVudGl0eVVwZGF0ZSkge1xyXG4gICAgZm9yIChjb25zdCBjaGlsZCBvZiBwYWNrZXQuZW50aXRpZXMpIHtcclxuICAgICAgY29uc3QgZW50aXR5ID0gdGhpcy5saXZpbmdFbnRpdGllcy5nZXQoY2hpbGQuaWQpO1xyXG4gICAgICBpZiAoIWVudGl0eSkgY29udGludWU7XHJcbiAgICAgIGVudGl0eS5yZWNlaXZlKGNoaWxkKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgcmVjZWl2ZVN5bmMocGFja2V0OiBhcHAuQmFzaWNTeW5jKSB7XHJcbiAgICBmb3IgKGNvbnN0IGVudGl0eSBvZiB0aGlzLmxpdmluZ0VudGl0aWVzLnZhbHVlcygpKSB7XHJcbiAgICAgIGlmICghZW50aXR5Lm9wdGlvbnMgfHwgIWVudGl0eS5vcHRpb25zLmVuYWJsZVVwZGF0ZSkgY29udGludWU7XHJcbiAgICAgIGVudGl0eS5yZWNlaXZlKHBhY2tldCk7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBjb252ZXJ0TWVtYmVycyhtZW1iZXJzOiBNYXA8bnVtYmVyLCBhcHAuRW50aXR5TWVtYmVyPikge1xyXG4gIGNvbnN0IHJlc3VsdDogQXJyYXk8YXBwLkVudGl0eUNyZWF0ZU1lbWJlcj4gPSBbXTtcclxuICBmb3IgKGNvbnN0IFtpZCwgbWVtYmVyXSBvZiBtZW1iZXJzKSByZXN1bHQucHVzaChuZXcgYXBwLkVudGl0eUNyZWF0ZU1lbWJlcihpZCwgbWVtYmVyLmludGVydmFsLCBtZW1iZXIuYnVmZmVyLmJ5dGVMZW5ndGgpKTtcclxuICByZXR1cm4gcmVzdWx0O1xyXG59XHJcbiJdfQ==