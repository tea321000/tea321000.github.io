"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Entity = void 0;
const app = require("..");
class Entity {
    constructor(address, members, options) {
        this.address = address;
        this.members = convertMembers(members);
        this.options = options;
    }
    receive(packet) {
        if (packet instanceof app.EntityUpdateEntity) {
            this.receiveUpdate(packet);
        }
        else {
            this.receiveSync(packet);
        }
    }
    update(id, syncId) {
        const packets = [];
        this.createUpdate(packets, syncId);
        return packets.length ? new app.EntityChange(id, packets) : undefined;
    }
    createUpdate(packets, syncId) {
        for (const member of this.members.values()) {
            const packet = member.update(syncId);
            if (!packet)
                continue;
            packets.push(packet);
        }
    }
    receiveUpdate(packet) {
        for (const child of packet.members) {
            const member = this.members.get(child.offset);
            if (!member)
                continue;
            member.receive(child);
        }
    }
    receiveSync(packet) {
        for (const member of this.members.values()) {
            member.receive(packet);
        }
    }
}
exports.Entity = Entity;
function convertMembers(members) {
    const result = new Map();
    for (const member of members)
        result.set(member.source.offset, member.source);
    return result;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRW50aXR5LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2xpYi9hcGkvY2xhc3Nlcy9FbnRpdHkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsMEJBQTBCO0FBRTFCLE1BQWEsTUFBTTtJQUtqQixZQUFZLE9BQWUsRUFBRSxPQUFnRCxFQUFFLE9BQWtCO1FBQy9GLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxPQUFPLEdBQUcsY0FBYyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3ZDLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO0lBQ3pCLENBQUM7SUFFRCxPQUFPLENBQUMsTUFBOEM7UUFDcEQsSUFBSSxNQUFNLFlBQVksR0FBRyxDQUFDLGtCQUFrQixFQUFFO1lBQzVDLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDNUI7YUFBTTtZQUNMLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDMUI7SUFDSCxDQUFDO0lBRUQsTUFBTSxDQUFDLEVBQVUsRUFBRSxNQUFjO1FBQy9CLE1BQU0sT0FBTyxHQUFrQyxFQUFFLENBQUM7UUFDbEQsSUFBSSxDQUFDLFlBQVksQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDbkMsT0FBTyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxZQUFZLENBQUMsRUFBRSxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7SUFDeEUsQ0FBQztJQUVPLFlBQVksQ0FBQyxPQUFzQyxFQUFFLE1BQWM7UUFDekUsS0FBSyxNQUFNLE1BQU0sSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxFQUFFO1lBQzFDLE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDckMsSUFBSSxDQUFDLE1BQU07Z0JBQUUsU0FBUztZQUN0QixPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQ3RCO0lBQ0gsQ0FBQztJQUVPLGFBQWEsQ0FBQyxNQUE4QjtRQUNsRCxLQUFLLE1BQU0sS0FBSyxJQUFJLE1BQU0sQ0FBQyxPQUFPLEVBQUU7WUFDbEMsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQzlDLElBQUksQ0FBQyxNQUFNO2dCQUFFLFNBQVM7WUFDdEIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUN2QjtJQUNILENBQUM7SUFFTyxXQUFXLENBQUMsTUFBcUI7UUFDdkMsS0FBSyxNQUFNLE1BQU0sSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxFQUFFO1lBQzFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDeEI7SUFDSCxDQUFDO0NBQ0Y7QUE5Q0Qsd0JBOENDO0FBRUQsU0FBUyxjQUFjLENBQUMsT0FBZ0Q7SUFDdEUsTUFBTSxNQUFNLEdBQUcsSUFBSSxHQUFHLEVBQTRCLENBQUM7SUFDbkQsS0FBSyxNQUFNLE1BQU0sSUFBSSxPQUFPO1FBQUUsTUFBTSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDOUUsT0FBTyxNQUFNLENBQUM7QUFDaEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGFwcCBmcm9tICcuLic7XHJcblxyXG5leHBvcnQgY2xhc3MgRW50aXR5IHtcclxuICByZWFkb25seSBhZGRyZXNzOiBiaWdpbnQ7XHJcbiAgcmVhZG9ubHkgbWVtYmVyczogTWFwPG51bWJlciwgYXBwLkVudGl0eU1lbWJlcj47XHJcbiAgcmVhZG9ubHkgb3B0aW9ucz86IElPcHRpb25zO1xyXG5cclxuICBjb25zdHJ1Y3RvcihhZGRyZXNzOiBiaWdpbnQsIG1lbWJlcnM6IEl0ZXJhYmxlPGFwcC5BZGFwdGVyPGFwcC5FbnRpdHlNZW1iZXI+Piwgb3B0aW9ucz86IElPcHRpb25zKSB7XHJcbiAgICB0aGlzLmFkZHJlc3MgPSBhZGRyZXNzO1xyXG4gICAgdGhpcy5tZW1iZXJzID0gY29udmVydE1lbWJlcnMobWVtYmVycyk7XHJcbiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zO1xyXG4gIH1cclxuXHJcbiAgcmVjZWl2ZShwYWNrZXQ6IGFwcC5CYXNpY1N5bmMgfCBhcHAuRW50aXR5VXBkYXRlRW50aXR5KSB7XHJcbiAgICBpZiAocGFja2V0IGluc3RhbmNlb2YgYXBwLkVudGl0eVVwZGF0ZUVudGl0eSkge1xyXG4gICAgICB0aGlzLnJlY2VpdmVVcGRhdGUocGFja2V0KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMucmVjZWl2ZVN5bmMocGFja2V0KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHVwZGF0ZShpZDogbnVtYmVyLCBzeW5jSWQ6IG51bWJlcikge1xyXG4gICAgY29uc3QgcGFja2V0czogQXJyYXk8YXBwLkVudGl0eUNoYW5nZU1lbWJlcj4gPSBbXTtcclxuICAgIHRoaXMuY3JlYXRlVXBkYXRlKHBhY2tldHMsIHN5bmNJZCk7XHJcbiAgICByZXR1cm4gcGFja2V0cy5sZW5ndGggPyBuZXcgYXBwLkVudGl0eUNoYW5nZShpZCwgcGFja2V0cykgOiB1bmRlZmluZWQ7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGNyZWF0ZVVwZGF0ZShwYWNrZXRzOiBBcnJheTxhcHAuRW50aXR5Q2hhbmdlTWVtYmVyPiwgc3luY0lkOiBudW1iZXIpIHtcclxuICAgIGZvciAoY29uc3QgbWVtYmVyIG9mIHRoaXMubWVtYmVycy52YWx1ZXMoKSkge1xyXG4gICAgICBjb25zdCBwYWNrZXQgPSBtZW1iZXIudXBkYXRlKHN5bmNJZCk7XHJcbiAgICAgIGlmICghcGFja2V0KSBjb250aW51ZTtcclxuICAgICAgcGFja2V0cy5wdXNoKHBhY2tldCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHJlY2VpdmVVcGRhdGUocGFja2V0OiBhcHAuRW50aXR5VXBkYXRlRW50aXR5KSB7XHJcbiAgICBmb3IgKGNvbnN0IGNoaWxkIG9mIHBhY2tldC5tZW1iZXJzKSB7XHJcbiAgICAgIGNvbnN0IG1lbWJlciA9IHRoaXMubWVtYmVycy5nZXQoY2hpbGQub2Zmc2V0KTtcclxuICAgICAgaWYgKCFtZW1iZXIpIGNvbnRpbnVlO1xyXG4gICAgICBtZW1iZXIucmVjZWl2ZShjaGlsZCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHJlY2VpdmVTeW5jKHBhY2tldDogYXBwLkJhc2ljU3luYykge1xyXG4gICAgZm9yIChjb25zdCBtZW1iZXIgb2YgdGhpcy5tZW1iZXJzLnZhbHVlcygpKSB7XHJcbiAgICAgIG1lbWJlci5yZWNlaXZlKHBhY2tldCk7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBjb252ZXJ0TWVtYmVycyhtZW1iZXJzOiBJdGVyYWJsZTxhcHAuQWRhcHRlcjxhcHAuRW50aXR5TWVtYmVyPj4pIHtcclxuICBjb25zdCByZXN1bHQgPSBuZXcgTWFwPG51bWJlciwgYXBwLkVudGl0eU1lbWJlcj4oKTtcclxuICBmb3IgKGNvbnN0IG1lbWJlciBvZiBtZW1iZXJzKSByZXN1bHQuc2V0KG1lbWJlci5zb3VyY2Uub2Zmc2V0LCBtZW1iZXIuc291cmNlKTtcclxuICByZXR1cm4gcmVzdWx0O1xyXG59XHJcblxyXG50eXBlIElPcHRpb25zID0ge1xyXG4gIGVuYWJsZVVwZGF0ZT86IGJvb2xlYW47XHJcbiAgcmVxdWVzdEJhdGNoPzogYm9vbGVhbjtcclxufVxyXG4iXX0=