"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Entity = void 0;
const app = require("..");
class Entity {
    constructor(address, members) {
        this.emitter = new EventTarget();
        this.address = address;
        this.members = toRecord(members.map(x => x.source));
    }
    receive(update) {
        this.emitter.dispatchEvent(new Event('preReceive'));
        update.members.forEach(x => this.members[x.offset.toString(16)]?.receive(x));
        this.emitter.dispatchEvent(new Event('postReceive'));
    }
    update() {
        const packets = Object.values(this.members)
            .map(x => x.update())
            .filter(Boolean)
            .map(x => x);
        return packets.length
            ? new app.ChangeEntity(this.address, packets)
            : undefined;
    }
}
exports.Entity = Entity;
function toRecord(members) {
    const result = {};
    for (const x of members)
        result[x.offset.toString(16)] ??= x;
    return result;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRW50aXR5LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2xpYi9hcGkvbW9kZWxzL0VudGl0eS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwwQkFBMEI7QUFFMUIsTUFBYSxNQUFNO0lBS2pCLFlBQVksT0FBZSxFQUFFLE9BQTZDO1FBSGpFLFlBQU8sR0FBRyxJQUFJLFdBQVcsRUFBRSxDQUFDO1FBSW5DLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxPQUFPLEdBQUcsUUFBUSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztJQUN0RCxDQUFDO0lBRUQsT0FBTyxDQUFDLE1BQXdCO1FBQzlCLElBQUksQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLElBQUksS0FBSyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7UUFDcEQsTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDN0UsSUFBSSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsSUFBSSxLQUFLLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztJQUN2RCxDQUFDO0lBRUQsTUFBTTtRQUNKLE1BQU0sT0FBTyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQzthQUN4QyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUM7YUFDcEIsTUFBTSxDQUFDLE9BQU8sQ0FBQzthQUNmLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUUsQ0FBQyxDQUFDO1FBQ2hCLE9BQU8sT0FBTyxDQUFDLE1BQU07WUFDbkIsQ0FBQyxDQUFDLElBQUksR0FBRyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQztZQUM3QyxDQUFDLENBQUMsU0FBUyxDQUFDO0lBQ2hCLENBQUM7Q0FDRjtBQXpCRCx3QkF5QkM7QUFFRCxTQUFTLFFBQVEsQ0FBQyxPQUFnQztJQUNoRCxNQUFNLE1BQU0sR0FBcUMsRUFBRSxDQUFDO0lBQ3BELEtBQUssTUFBTSxDQUFDLElBQUksT0FBTztRQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUM3RCxPQUFPLE1BQU0sQ0FBQztBQUNoQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgYXBwIGZyb20gJy4uJztcclxuXHJcbmV4cG9ydCBjbGFzcyBFbnRpdHkge1xyXG4gIHJlYWRvbmx5IGFkZHJlc3M6IGJpZ2ludDtcclxuICByZWFkb25seSBlbWl0dGVyID0gbmV3IEV2ZW50VGFyZ2V0KCk7XHJcbiAgcmVhZG9ubHkgbWVtYmVyczogUmVjb3JkPHN0cmluZywgYXBwLkVudGl0eU1lbWJlcj47XHJcblxyXG4gIGNvbnN0cnVjdG9yKGFkZHJlc3M6IGJpZ2ludCwgbWVtYmVyczogQXJyYXk8YXBwLkFkYXB0ZXI8YXBwLkVudGl0eU1lbWJlcj4+KSB7XHJcbiAgICB0aGlzLmFkZHJlc3MgPSBhZGRyZXNzO1xyXG4gICAgdGhpcy5tZW1iZXJzID0gdG9SZWNvcmQobWVtYmVycy5tYXAoeCA9PiB4LnNvdXJjZSkpO1xyXG4gIH1cclxuXHJcbiAgcmVjZWl2ZSh1cGRhdGU6IGFwcC5VcGRhdGVFbnRpdHkpIHtcclxuICAgIHRoaXMuZW1pdHRlci5kaXNwYXRjaEV2ZW50KG5ldyBFdmVudCgncHJlUmVjZWl2ZScpKTtcclxuICAgIHVwZGF0ZS5tZW1iZXJzLmZvckVhY2goeCA9PiB0aGlzLm1lbWJlcnNbeC5vZmZzZXQudG9TdHJpbmcoMTYpXT8ucmVjZWl2ZSh4KSk7XHJcbiAgICB0aGlzLmVtaXR0ZXIuZGlzcGF0Y2hFdmVudChuZXcgRXZlbnQoJ3Bvc3RSZWNlaXZlJykpO1xyXG4gIH1cclxuXHJcbiAgdXBkYXRlKCkge1xyXG4gICAgY29uc3QgcGFja2V0cyA9IE9iamVjdC52YWx1ZXModGhpcy5tZW1iZXJzKVxyXG4gICAgICAubWFwKHggPT4geC51cGRhdGUoKSlcclxuICAgICAgLmZpbHRlcihCb29sZWFuKVxyXG4gICAgICAubWFwKHggPT4geCEpO1xyXG4gICAgcmV0dXJuIHBhY2tldHMubGVuZ3RoXHJcbiAgICAgID8gbmV3IGFwcC5DaGFuZ2VFbnRpdHkodGhpcy5hZGRyZXNzLCBwYWNrZXRzKVxyXG4gICAgICA6IHVuZGVmaW5lZDtcclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHRvUmVjb3JkKG1lbWJlcnM6IEFycmF5PGFwcC5FbnRpdHlNZW1iZXI+KSB7XHJcbiAgY29uc3QgcmVzdWx0OiBSZWNvcmQ8c3RyaW5nLCBhcHAuRW50aXR5TWVtYmVyPiA9IHt9O1xyXG4gIGZvciAoY29uc3QgeCBvZiBtZW1iZXJzKSByZXN1bHRbeC5vZmZzZXQudG9TdHJpbmcoMTYpXSA/Pz0geDtcclxuICByZXR1cm4gcmVzdWx0O1xyXG59XHJcbiJdfQ==